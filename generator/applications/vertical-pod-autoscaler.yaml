
name: vertical-pod-autoscaler
productName: Vertical Pod Autoscaler
appVersion: 1.3.1
description: is a <<set of components that automatically adjust the amount of CPU and memory requested by pods running in the Kubernetes Cluster>>
home: https://github.com/kubernetes/autoscaler
icon: https://raw.githubusercontent.com/kubernetes/kubernetes/master/logo/logo.svg
license: 2020
source: https://github.com/kubernetes/autoscaler
version: 10.0.1
prerequisites: |
  - Metrics Server >= 0.2 (you can use the [bitnami/metrics-server](https://artifacthub.io/packages/helm/bitnami/metrics-server) chart)
updates: |
  ### Upgrading to version 10.0.0

  The application has been updated to a major release, see the release notes for breaking changes:

  - https://github.com/kubernetes/autoscaler/releases/tag/vertical-pod-autoscaler-1.3.0

  Information about services are no more injected into pod's environment variable.

  ### Upgrading to version 9.0.0

  The chart is now tested with Kubernetes >= 1.24 and Helm >= 3.9.

  Future upgrades may introduce undetected breaking changes if you continue to use older versions.

  ### Upgrading to version 8.0.0

  Some parameters related to port management have been modified:

  - Parameter `admissionController.metrics.service.port` has been renamed `admissionController.metrics.service.ports.metrics`.
  - Parameter `recommender.metrics.service.port` has been renamed `recommender.metrics.service.ports.metrics`.
  - Parameter `updater.metrics.service.port` has been renamed `updater.metrics.service.ports.metrics`.

  ### Upgrading to version 7.0.0

  Some parameters related to image management have been modified:

  - Registry prefix in `image.repository` parameters is now configured in `image.registry`.
  - Parameter `imagePullSecrets` has been renamed `global.imagePullSecrets`.

  ### Upgrading to version 6.0.0

  The application version is no more compatible with Kubernetes 1.19, 1.20 and 1.21.

  ### Upgrading to version 5.0.0

  The application validates that all fields that specify CPU and memory have supported resolution:

  - CPU is a whole number of milli CPUs
  - Memory is a whole number of bytes

  ### Upgrading to version 4.0.0

  The application version is no more compatible with Kubernetes 1.16.

  Custom resource definitions are now created and upgraded with a pre-install/pre-upgrade job.

  ### Upgrading to version 3.0.0

  The chart is no more compatible with Helm 2.

  Refer to the [Helm documentation](https://helm.sh/docs/topics/v2_v3_migration/) for more information.

  ### Upgrading to version 2.0.0

  The port names have been changed to be compatible with Istio service mesh.
uninstalling: |
  Delete the `vpa-webhook-config` mutating webhook configuration automatically created by Vertical Pod Autoscaler admission controller component using:

  ```bash
  $ kubectl delete mutatingwebhookconfiguration vpa-webhook-config
  ```

  Optionally, delete the custom resource definitions created by the chart using:

  **WARNING**: It will also try to delete all instances of the custom resource definitions.

  ```bash
  $ kubectl delete crd verticalpodautoscalers.autoscaling.k8s.io
  $ kubectl delete crd verticalpodautoscalercheckpoints.autoscaling.k8s.io
  ```
readme: |
  ## Limitations

  Due to hard-coded values in Vertical Pod Autoscaler, the chart configuration has some limitations:

  - Admission controller component service name is `vpa-webhook`
  - Admission controller component service port is `443`
  - Mutating webhook configuration name automatically created by admission controller component is `vpa-webhook-config`
components:
  - name: admission-controller
    description: Admission controller
    optional: true
    admissionWebhook: true
    clusterrole: |
      # system:vpa-target-reader
      - apiGroups:
          - "*"
        resources:
          - "*/scale"
        verbs:
          - get
          - watch
      - apiGroups:
          - ""
        resources:
          - replicationcontrollers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - apps
        resources:
          - daemonsets
          - deployments
          - replicasets
          - statefulsets
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - batch
        resources:
          - jobs
          - cronjobs
        verbs:
          - get
          - list
          - watch
      # system:vpa-admission-controller
      - apiGroups:
          - ""
        resources:
          - pods
          - configmaps
          - nodes
          - limitranges
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - "admissionregistration.k8s.io"
        resources:
          - mutatingwebhookconfigurations
        verbs:
          - create
          - delete
          - get
          - list
      - apiGroups:
          - "poc.autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - "autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - "coordination.k8s.io"
        resources:
          - leases
        verbs:
          - create
          - update
          - get
          - list
          - watch
    deployment:
      type: deployment
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
      container:
        args: |
          - --address=:{{ .Values.admissionController.containerPorts.metrics }}
          - --port={{ .Values.admissionController.containerPorts.https }}
          - --client-ca-file=/tls-secret/ca.crt
          - --tls-cert-file=/tls-secret/tls.crt
          - --tls-private-key=/tls-secret/tls.key
        extraArgs: |
          # kube-api-burst: 10
          # kube-api-qps: 5
          v: 2
          # vpa-object-namespace: ""
          # webhook-timeout-seconds: 30
        extraArgsDoc: |
          ## @param admissionController.extraArgs.v Number for the log level verbosity
        env: |
          - name: NAMESPACE
            value: {{ include "common.names.namespace" . | quote }}
        livenessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        readinessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        startupProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        resources:
          limits:
            cpu: 200m
            memory: 512Mi
          requests:
            cpu: 50m
            memory: 256Mi
        volumeMounts: |
          - name: tls-secret
            mountPath: /tls-secret
            readOnly: true
    image:
      registry: registry.k8s.io
      repository: autoscaling/vpa-admission-controller
      tag: 1.3.1
    metrics:
      ports:
        - name: metrics
          nameContainer: http-metrics
          nameService: http-metrics
          number: 8944
          description: Metrics
    service:
      internal: true
      nameOverride: vpa-webhook
      ports:
        - name: https
          number: 8000
          numberOverride: 443
          description: HTTPS
    serviceMonitor: true
    tls: true
  - name: recommender
    description: Recommender
    clusterrole: |
      # system:metrics-reader
      - apiGroups:
          - "metrics.k8s.io"
        resources:
          - pods
        verbs:
          - get
          - list
      # system:vpa-actor
      - apiGroups:
          - ""
        resources:
          - pods
          - nodes
          - limitranges
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - events
        verbs:
          - get
          - list
          - watch
          - create
      - apiGroups:
          - "poc.autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - "autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      # system:vpa-status-actor
      - apiGroups:
          - "autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers/status
        verbs:
          - get
          - patch
      # system:vpa-checkpoint-actor
      - apiGroups:
          - "poc.autoscaling.k8s.io"
        resources:
          - verticalpodautoscalercheckpoints
        verbs:
          - get
          - list
          - watch
          - create
          - patch
          - delete
      - apiGroups:
          - "autoscaling.k8s.io"
        resources:
          - verticalpodautoscalercheckpoints
        verbs:
          - get
          - list
          - watch
          - create
          - patch
          - delete
      - apiGroups:
          - ""
        resources:
          - namespaces
        verbs:
          - get
          - list
      # system:vpa-target-reader
      - apiGroups:
          - "*"
        resources:
          - "*/scale"
        verbs:
          - get
          - watch
      - apiGroups:
          - ""
        resources:
          - replicationcontrollers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - apps
        resources:
          - daemonsets
          - deployments
          - replicasets
          - statefulsets
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - batch
        resources:
          - jobs
          - cronjobs
        verbs:
          - get
          - list
          - watch
      # system:leader-locking-vpa-recommender
      - apiGroups:
          - "coordination.k8s.io"
        resources:
          - leases
        verbs:
          - create
      - apiGroups:
          - "coordination.k8s.io"
        resourceNames:
          - vpa-recommender
          - vpa-recommender-lease
        resources:
          - leases
        verbs:
          - get
          - watch
          - update
    deployment:
      type: deployment
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
      container:
        args: |
          - --address=:{{ .Values.recommender.containerPorts.metrics }}
        extraArgs: |
          # checkpoints-gc-interval: 10m0s
          # checkpoints-timeout: 1m0s
          # container-name-label: name
          # container-namespace-label: namespace
          # container-pod-name-label: pod_name
          # cpu-histogram-decay-half-life: 24h0m0s
          # cpu-integer-post-processor-enabled: false
          # external-metrics-cpu-metric: ""
          # external-metrics-memory-metric: ""
          # history-length: 8d
          # history-resolution: 1h
          # ignored-vpa-object-namespaces: ""
          # kube-api-burst: 10
          # kube-api-qps: 5
          # leader-elect: false
          # leader-elect-lease-duration: 15s
          # leader-elect-renew-deadline: 10s
          # leader-elect-resource-lock: leases
          # leader-elect-resource-name: vpa-recommender
          # leader-elect-resource-namespace: kube-system
          # leader-elect-retry-period: 2s
          # memory-aggregation-interval: 24h0m0s
          # memory-aggregation-interval-count: 8
          # memory-histogram-decay-half-life: 24h0m0s
          # memory-saver: false
          # metric-for-pod-labels: up{job="kubernetes-pods"}
          # min-checkpoints: 10
          # oom-bump-up-ratio: 1.2
          # oom-min-bump-up-bytes: 104857600
          # password: ""
          # pod-label-prefix: pod_label_
          # pod-name-label: kubernetes_pod_name
          # pod-namespace-label: kubernetes_namespace
          # pod-recommendation-min-cpu-millicores: 25
          # pod-recommendation-min-memory-mb: 250
          # prometheus-address: ""
          # prometheus-cadvisor-job-name: kubernetes-cadvisor
          # prometheus-query-timeout: 5m
          # recommendation-lower-bound-cpu-percentile: 0.5
          # recommendation-lower-bound-memory-percentile: 0.5
          # recommendation-margin-fraction: 0.15
          # recommendation-upper-bound-cpu-percentile: 0.95
          # recommendation-upper-bound-memory-percentile: 0.95
          # recommender-interval: 1m0s
          # recommender-name: default
          # storage: checkpoint
          # target-cpu-percentile: 0.9
          # target-memory-percentile: 0.9
          # use-external-metrics: false
          # username: ""
          v: 2
          # vpa-object-namespace: ""
        extraArgsDoc: |
          ## @param recommender.extraArgs.v Number for the log level verbosity
        livenessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        readinessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        startupProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        resources:
          limits:
            cpu: 200m
            memory: 1024Mi
          requests:
            cpu: 50m
            memory: 512Mi
    image:
      registry: registry.k8s.io
      repository: autoscaling/vpa-recommender
      tag: 1.3.1
    metrics:
      ports:
        - name: metrics
          nameContainer: http-metrics
          nameService: http-metrics
          number: 8942
          description: Metrics
    serviceMonitor: true
  - name: updater
    description: Updater
    optional: true
    clusterrole: |
      # system:vpa-actor
      - apiGroups:
          - ""
        resources:
          - pods
          - nodes
          - limitranges
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - ""
        resources:
          - events
        verbs:
          - get
          - list
          - watch
          - create
      - apiGroups:
          - "poc.autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - "autoscaling.k8s.io"
        resources:
          - verticalpodautoscalers
        verbs:
          - get
          - list
          - watch
      # system:vpa-target-reader
      - apiGroups:
          - "*"
        resources:
          - "*/scale"
        verbs:
          - get
          - watch
      - apiGroups:
          - ""
        resources:
          - replicationcontrollers
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - apps
        resources:
          - daemonsets
          - deployments
          - replicasets
          - statefulsets
        verbs:
          - get
          - list
          - watch
      - apiGroups:
          - batch
        resources:
          - jobs
          - cronjobs
        verbs:
          - get
          - list
          - watch
      # system:evictioner
      - apiGroups:
          - "apps"
          - "extensions"
        resources:
          - replicasets
        verbs:
          - get
      - apiGroups:
          - ""
        resources:
          - pods/eviction
        verbs:
          - create
      # system:vpa-status-reader
      - apiGroups:
          - "coordination.k8s.io"
        resources:
          - leases
        verbs:
          - get
          - list
          - watch
      # system:leader-locking-vpa-updater
      - apiGroups:
          - "coordination.k8s.io"
        resources:
          - leases
        verbs:
          - create
      - apiGroups:
          - "coordination.k8s.io"
        resourceNames:
          - vpa-updater
        resources:
          - leases
        verbs:
          - get
          - watch
          - update
    deployment:
      type: deployment
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
      container:
        args: |
          - --address=:{{ .Values.updater.containerPorts.metrics }}
        extraArgs: |
          # evict-after-oom-threshold: 10m0s
          # eviction-rate-burst: 1
          # eviction-rate-limit: -1
          # eviction-tolerance: 0.5
          # ignored-vpa-object-namespaces: ""
          # in-recommendation-bounds-eviction-lifetime-threshold: 12h0m0s
          # kube-api-burst: 10
          # kube-api-qps: 5
          # leader-elect: false
          # leader-elect-lease-duration: 15s
          # leader-elect-renew-deadline: 10s
          # leader-elect-resource-lock: leases
          # leader-elect-resource-name: vpa-updater
          # leader-elect-resource-namespace: kube-system
          # leader-elect-retry-period: 2s
          # min-replicas: 2
          # pod-update-threshold: 0.1
          # updater-interval: 1m0s
          # use-admission-controller-status: true
          v: 2
          # vpa-object-namespace: ""
        extraArgsDoc: |
          ## @param updater.extraArgs.v Number for the log level verbosity
        env: |
          - name: NAMESPACE
            value: {{ include "common.names.namespace" . | quote }}
        livenessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        readinessProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        startupProbe:
          httpGet:
            path: /health-check
            port: http-metrics
        resources:
          limits:
            cpu: 200m
            memory: 1024Mi
          requests:
            cpu: 50m
            memory: 512Mi
    image:
      registry: registry.k8s.io
      repository: autoscaling/vpa-updater
      tag: 1.3.1
    metrics:
      ports:
        - name: metrics
          nameContainer: http-metrics
          nameService: http-metrics
          number: 8943
          description: Metrics
    serviceMonitor: true
crds: true
tests: |
  import requests


  def test_admission_controller_service_connection():s
      url = "https://vpa-webhook.{{ include "common.names.namespace" . }}.svc:{{ .Values.admissionController.service.ports.https }}/"
      verify = "/admission-controller-tls-secret/ca.crt"

      response = requests.get(url, verify=verify)

      assert response.status_code == 200


  def test_admission_controller_metrics_service_connection():
      url = "http://{{ include "vertical-pod-autoscaler.admissionController.metrics.fullname" . }}:{{ .Values.admissionController.metrics.service.ports.metrics }}/metrics"

      response = requests.get(url)

      assert response.status_code == 200


  def test_recommender_metrics_service_connection():
      url = "http://{{ include "vertical-pod-autoscaler.recommender.metrics.fullname" . }}:{{ .Values.recommender.metrics.service.ports.metrics }}/metrics"

      response = requests.get(url)

      assert response.status_code == 200


  def test_updater_metrics_service_connection():
      url = "http://{{ include "vertical-pod-autoscaler.updater.metrics.fullname" . }}:{{ .Values.updater.metrics.service.ports.metrics }}/metrics"

      response = requests.get(url)

      assert response.status_code == 200
testVolumes: |
  - name: admission-controller-tls-secret
    secret:
      secretName: {{ include "vertical-pod-autoscaler.admissionController.tls.secretName" . }}
testVolumeMounts: |
  - name: admission-controller-tls-secret
    mountPath: /admission-controller-tls-secret
    readOnly: true
