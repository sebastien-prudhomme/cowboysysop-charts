name: dolibarr
productName: Dolibarr
appVersion: 15.0.3
description: is <<a modern software package to manage your company or foundation's activity>>
home: https://www.dolibarr.org/
icon: https://raw.githubusercontent.com/Dolibarr/dolibarr/develop/doc/images/dolibarr_256x256_color.svg
source: https://github.com/Dolibarr/dolibarr
version: 3.0.0
prerequisites: |
  - Kubernetes >= 1.19
updates: |
  ### Upgrading to version 3.0.0

  Some parameters related to port management have been modified:

  - Parameter `service.port` has been renamed `service.ports.http`.
  - Parameter `service.nodePort` has been renamed `service.nodePorts.http`.

  ### Upgrading to version 2.0.0

  Some parameters related to image management have been modified:

  - Registry prefix in `image.repository` parameters is now configured in `image.registry`.
  - Parameter `imagePullSecrets` has been renamed `global.imagePullSecrets`.
components:
  - name: dolibarr
    deployment:
      type: deployment
      initContainer:
        command: |
          - /bin/bash
          - -ec
          - |
            rm -f /var/www/documents/install.lock
        volumeMounts: |
          - name: data
            mountPath: /var/www/documents
      container:
        env: |
          - name: DOLI_ADMIN_LOGIN
            value: {{ .Values.dolibarr.admin.username | quote }}
          - name: DOLI_ADMIN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "dolibarr.secretName" . }}
                key: dolibarr-admin-password
          - name: DOLI_DB_HOST
            value: {{ include "dolibarr.mariadb.host" . | quote }}
          - name: DOLI_DB_HOST_PORT
            value: {{ include "dolibarr.mariadb.port" . | quote }}
          - name: DOLI_DB_USER
            value: {{ include "dolibarr.mariadb.username" . | quote }}
          - name: DOLI_DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "dolibarr.mariadb.secretName" . }}
                key: {{ include "dolibarr.mariadb.secretKeyNamePassword" . }}
          - name: DOLI_DB_NAME
            value: {{ include "dolibarr.mariadb.database" . | quote }}
          - name: DOLI_URL_ROOT
            value: {{ .Values.dolibarr.externalUrl | quote }}
        livenessProbe:
          initialDelaySeconds: 180
          httpGet:
            path: /
        readinessProbe:
          httpGet:
            path: /
        volumeMounts: |
          - name: data
            mountPath: /var/www/documents
      containers:
        - name: cron
          optional: true
          env: |
            - name: DOLI_CRON
              value: "1"
            - name: DOLI_CRON_USER
              value: {{ .Values.dolibarr.cron.username | quote }}
            - name: DOLI_CRON_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "dolibarr.secretName" . }}
                  key: dolibarr-cron-security-key
            - name: DOLI_DB_HOST
              value: {{ include "dolibarr.mariadb.host" . | quote }}
            - name: DOLI_DB_HOST_PORT
              value: {{ include "dolibarr.mariadb.port" . | quote }}
            - name: DOLI_DB_USER
              value: {{ include "dolibarr.mariadb.username" . | quote }}
            - name: DOLI_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "dolibarr.mariadb.secretName" . }}
                  key: {{ include "dolibarr.mariadb.secretKeyNamePassword" . }}
            - name: DOLI_DB_NAME
              value: {{ include "dolibarr.mariadb.database" . | quote }}
          volumeMounts: |
            - name: data
              mountPath: /var/www/documents
    image:
      registry: docker.io
      repository: tuxgasy/dolibarr
      tag: 15.0.3
    ingress: true
    persistentvolumeclaim: true
    secret: |
      dolibarr-admin-password: {{ .Values.dolibarr.admin.password | b64enc | quote }}
      {{- if .Values.dolibarr.cron.enabled }}
      dolibarr-cron-security-key: {{ .Values.dolibarr.cron.securityKey | b64enc | quote }}
      {{- end }}
    service:
      ports:
        - name: http
          number: 80
          numberForward: 8080
          description: HTTP
    extraValues: |
      dolibarr:
        admin:
          ## @param dolibarr.admin.username Administrator username
          username: admin

          ## @param dolibarr.admin.password Administrator password
          password: admin

        ## @param dolibarr.externalUrl External URL
        externalUrl: http://dolibarr.local

        cron:
          ## @param dolibarr.cron.enabled Enable cron for scheduled jobs
          enabled: false

          ## @param dolibarr.cron.username Cron username
          username: admin

          ## @param dolibarr.cron.securityKey Cron security key
          securityKey: ""
mariadb: true
tests: |
  import requests


  def test_service_connection():
      url = "http://{{ include "dolibarr.fullname" . }}:{{ .Values.service.ports.http }}/"

      response = requests.get(url)

      assert response.status_code == 200
